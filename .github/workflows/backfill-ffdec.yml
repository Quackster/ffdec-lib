name: Backfill ffdec-lib from upstream releases (run once)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq unzip

      - name: Backfill all stable upstream releases
        env:
          UPSTREAM: jindrapetrik/jpexs-decompiler
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          root_dir="${GITHUB_WORKSPACE}/lib/com/jpexs/ffdec-lib"
          mkdir -p "$root_dir"

          # ----------------------------
          # Fetch ALL releases (paged)
          # ----------------------------
          all_releases="$(mktemp)"
          : > "$all_releases"

          page=1
          while :; do
            echo "Fetching releases page ${page}..."
            page_json="$(curl -fsSL \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              "https://api.github.com/repos/${UPSTREAM}/releases?per_page=100&page=${page}")"

            count="$(echo "$page_json" | jq 'length')"
            if [[ "$count" -eq 0 ]]; then
              break
            fi

            echo "$page_json" >> "$all_releases"
            page=$((page+1))
          done

          releases_json="$(jq -s 'add' "$all_releases")"

          # ----------------------------
          # Filter stable releases
          # ----------------------------
          stable="$(echo "$releases_json" | jq '
            map(select(.draft == false and .prerelease == false))
            | sort_by(.published_at)
          ')"

          stable_count="$(echo "$stable" | jq 'length')"
          if [[ "$stable_count" -eq 0 ]]; then
            echo "No stable releases found."
            exit 0
          fi

          echo "Found ${stable_count} stable releases."

          added=0
          skipped=0
          failed=0

          work="$(mktemp -d)"
          trap 'rm -rf "$work" "$all_releases"' EXIT

          # ----------------------------
          # Process each release
          # ----------------------------
          echo "$stable" | jq -r '
            .[]
            | .tag_name as $tag
            | ($tag | sub("^v"; "")) as $version
            | (
                .assets
                | map(select(.browser_download_url | test("(?i)ffdec.*\\.zip$")))
                | .[0].browser_download_url
              ) as $asset_url
            | [$tag, $version, ($asset_url // "")]
            | @tsv
          ' | while IFS=$'\t' read -r tag version asset_url; do

            if [[ -z "$tag" || -z "$version" || -z "$asset_url" ]]; then
              echo "Skipping release (no usable asset): tag=${tag}"
              failed=$((failed+1))
              continue
            fi

            target_dir="${root_dir}/${version}"
            if [[ -d "$target_dir" ]]; then
              echo "SKIP ${version} (already exists)"
              skipped=$((skipped+1))
              continue
            fi

            echo "ADD  ${version} from ${tag}"
            mkdir -p "$target_dir"

            zip_path="${work}/ffdec_${version}.zip"
            echo "  Downloading asset"
            if ! curl -fL \
              -H "Accept: application/octet-stream" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              -o "$zip_path" \
              "$asset_url"; then
              echo "  ERROR downloading asset"
              rm -rf "$target_dir"
              failed=$((failed+1))
              continue
            fi

            echo "  Extracting"
            if ! unzip -q "$zip_path" -d "$target_dir"; then
              echo "  ERROR extracting zip"
              rm -rf "$target_dir"
              failed=$((failed+1))
              continue
            fi

            rm -f "$zip_path"
            added=$((added+1))
          done

          # ----------------------------
          # Commit once at the end
          # ----------------------------
          echo "Summary: added=${added}, skipped=${skipped}, failed=${failed}"

          if [[ "$added" -gt 0 ]]; then
            git status --porcelain
            git add "$root_dir"
            git commit -m "Backfill ffdec-lib from upstream releases"
            git push
          else
            echo "No new versions added; nothing to commit."
          fi
