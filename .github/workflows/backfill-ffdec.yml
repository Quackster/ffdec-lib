name: Sync ffdec-lib from all upstream releases (manual)

on:
  workflow_dispatch:
    inputs:
      include_prereleases:
        description: "Include prereleases"
        required: false
        type: boolean
        default: false
      include_drafts:
        description: "Include drafts"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  sync_all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync all upstream releases into lib/ tree
        id: sync
        env:
          UPSTREAM: jindrapetrik/jpexs-decompiler
          INCLUDE_PRERELEASES: ${{ inputs.include_prereleases }}
          INCLUDE_DRAFTS: ${{ inputs.include_drafts }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          # Helpers
          api() {
            curl -fsSL \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer ${GH_TOKEN}" \
              "$@"
          }

          work="$(mktemp -d)"
          mkdir -p "$work"
          releases_json="$work/releases.json"
          : > "$releases_json"

          echo "Fetching ALL releases from ${UPSTREAM} ..."
          page=1
          while true; do
            url="https://api.github.com/repos/${UPSTREAM}/releases?per_page=100&page=${page}"
            page_json="$(api "$url")"
            count="$(echo "$page_json" | jq 'length')"
            if [[ "$count" -eq 0 ]]; then
              break
            fi
            # Append arrays together
            tmp="$work/tmp.json"
            jq -s '.[0] + .[1]' "$releases_json" <(echo "$page_json") > "$tmp"
            mv "$tmp" "$releases_json"
            page=$((page+1))
          done

          total="$(jq 'length' "$releases_json")"
          echo "Fetched ${total} releases."

          include_prereleases="${INCLUDE_PRERELEASES:-false}"
          include_drafts="${INCLUDE_DRAFTS:-false}"

          # Filter releases per inputs; then sort oldest->newest so metadata/latest ends correct
          filtered="$work/filtered.json"
          jq \
            --argjson include_prereleases "$( [[ "$include_prereleases" == "true" ]] && echo true || echo false )" \
            --argjson include_drafts "$( [[ "$include_drafts" == "true" ]] && echo true || echo false )" \
            '
            map(
              select(
                ($include_drafts or (.draft == false)) and
                ($include_prereleases or (.prerelease == false))
              )
            )
            | sort_by(.published_at // .created_at // "9999-12-31T00:00:00Z")
            ' "$releases_json" > "$filtered"

          filtered_total="$(jq 'length' "$filtered")"
          echo "Processing ${filtered_total} releases after filtering (drafts=${include_drafts}, prereleases=${include_prereleases})."

          added_versions=()

          # Ensure artifact root exists
          artifact_root="${GITHUB_WORKSPACE}/lib/com/jpexs/ffdec-lib"
          mkdir -p "$artifact_root"

          process_one_release() {
            local tag="$1"
            local version="${tag#version}"

            if [[ -z "$version" || "$version" == "$tag" ]]; then
              # If tag isn't prefixed, still allow it as version
              version="$tag"
            fi

            local target_dir="${artifact_root}/${version}"
            if [[ -d "$target_dir" ]]; then
              echo "✓ ${version} already exists (${target_dir})"
              return 0
            fi

            # Find the "Library only" zip asset; exclude javadoc zip
            local asset_url
            asset_url="$(jq -r --arg tag "$tag" '
              map(select(.tag_name == $tag)) | .[0].assets
              | map(select(.name | test("^ffdec_lib_") and (test("javadoc")|not) and test("\\.zip$")))
              | .[0].browser_download_url // empty
            ' "$filtered")"

            if [[ -z "$asset_url" ]]; then
              echo "⚠️  Skipping ${tag}: could not find ffdec_lib_*.zip (non-javadoc) asset."
              return 0
            fi

            echo "→ Adding ${version} from ${asset_url}"

            local rel_work
            rel_work="$(mktemp -d)"
            pushd "$rel_work" >/dev/null

            curl -fL -o ffdec_lib.zip "$asset_url"
            mkdir extracted
            unzip -q ffdec_lib.zip -d extracted

            # Locate jar:
            # 1) ffdec_lib*.jar
            # 2) any *.jar (largest)
            local jar_path=""
            jar_path="$(find extracted -type f -iname "ffdec_lib*.jar" | head -n 1 || true)"
            if [[ -z "$jar_path" ]]; then
              jar_path="$(find extracted -type f -iname "*.jar" -printf "%s\t%p\n" \
                | sort -nr | head -n 1 | cut -f2- || true)"
            fi

            if [[ -z "$jar_path" || ! -f "$jar_path" ]]; then
              echo "❌ Could not find a jar inside ffdec_lib.zip for ${tag}" >&2
              echo "Contents:" >&2
              find extracted -maxdepth 4 -type f >&2 || true
              popd >/dev/null
              rm -rf "$rel_work"
              exit 1
            fi

            mkdir -p "$target_dir"
            local jar_out="${target_dir}/ffdec-lib-${version}.jar"
            cp "$jar_path" "$jar_out"

            local pom_out="${target_dir}/ffdec-lib-${version}.pom"
            cat > "$pom_out" <<EOF
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
            <modelVersion>4.0.0</modelVersion>

            <groupId>com.jpexs</groupId>
            <artifactId>ffdec-lib</artifactId>
            <version>${version}</version>
            <packaging>jar</packaging>

            <name>FFDec Library</name>
            <description>FFDec (JPEXS Free Flash Decompiler) library jar redistributed for Maven-style consumption.</description>
            <licenses>
              <license>
                <name>GNU Lesser General Public License, Version 3.0</name>
                <url>https://www.gnu.org/licenses/lgpl-3.0.html</url>
                <distribution>repo</distribution>
              </license>
            </licenses>

            <scm>
              <url>https://github.com/jindrapetrik/jpexs-decompiler</url>
            </scm>
          </project>
          EOF

            (cd "$target_dir" && \
              md5sum "ffdec-lib-${version}.jar" > "ffdec-lib-${version}.jar.md5" && \
              sha1sum "ffdec-lib-${version}.jar" > "ffdec-lib-${version}.jar.sha1" && \
              md5sum "ffdec-lib-${version}.pom" > "ffdec-lib-${version}.pom.md5" && \
              sha1sum "ffdec-lib-${version}.pom" > "ffdec-lib-${version}.pom.sha1")

            popd >/dev/null
            rm -rf "$rel_work"

            added_versions+=("$version")
          }

          # Iterate releases in order
          while IFS=$'\t' read -r tag; do
            [[ -z "$tag" ]] && continue
            process_one_release "$tag"
          done < <(jq -r '.[] | .tag_name // empty' "$filtered")

          # Rebuild maven-metadata.xml from directories present (source of truth)
          python3 - <<'PY'
          import os, re, xml.etree.ElementTree as ET
          from datetime import datetime, timezone

          root_dir = os.path.join(os.environ["GITHUB_WORKSPACE"], "lib", "com", "jpexs", "ffdec-lib")
          os.makedirs(root_dir, exist_ok=True)
          meta_path = os.path.join(root_dir, "maven-metadata.xml")

          # Collect versions from directory names that contain a matching jar
          versions = []
          for name in os.listdir(root_dir):
            p = os.path.join(root_dir, name)
            if not os.path.isdir(p):
              continue
            jar = os.path.join(p, f"ffdec-lib-{name}.jar")
            pom = os.path.join(p, f"ffdec-lib-{name}.pom")
            if os.path.isfile(jar) and os.path.isfile(pom):
              versions.append(name)

          def key(v):
            # best-effort numeric dot sort, then fallback
            try:
              return (0, tuple(int(x) for x in v.split(".")))
            except Exception:
              return (1, v)

          versions = sorted(set(versions), key=key)

          md = ET.Element("metadata")
          ET.SubElement(md, "groupId").text = "com.jpexs"
          ET.SubElement(md, "artifactId").text = "ffdec-lib"
          versioning = ET.SubElement(md, "versioning")

          latest = ET.SubElement(versioning, "latest")
          release = ET.SubElement(versioning, "release")
          versions_el = ET.SubElement(versioning, "versions")
          for v in versions:
            ET.SubElement(versions_el, "version").text = v

          chosen = versions[-1] if versions else ""
          latest.text = chosen
          release.text = chosen

          last_updated = ET.SubElement(versioning, "lastUpdated")
          last_updated.text = datetime.now(timezone.utc).strftime("%Y%m%d%H%M%S")

          def indent(elem, level=0):
            i = "\n" + level*"  "
            if len(elem):
              if not elem.text or not elem.text.strip():
                elem.text = i + "  "
              for e in elem:
                indent(e, level+1)
              if not e.tail or not e.tail.strip():
                e.tail = i
            else:
              if level and (not elem.tail or not elem.tail.strip()):
                elem.tail = i

          indent(md)
          ET.ElementTree(md).write(meta_path, encoding="utf-8", xml_declaration=True)
          PY

          # Output what we added for the commit step
          if [[ "${#added_versions[@]}" -gt 0 ]]; then
            {
              echo "added=true"
              echo "added_versions<<EOF"
              printf "%s\n" "${added_versions[@]}"
              echo "EOF"
            } >> "$GITHUB_OUTPUT"
          else
            echo "added=false" >> "$GITHUB_OUTPUT"
          fi

          echo "Done. Added versions count: ${#added_versions[@]}"

      - name: Commit and push changes
        if: steps.sync.outputs.added == 'true'
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Only commit if there are actual changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git add lib/

          # Build a readable commit message
          msg_title="Sync ffdec-lib: add missing upstream releases"
          msg_body="$(printf "Added versions:\n%s\n\nSource: jindrapetrik/jpexs-decompiler\n" "${{ steps.sync.outputs.added_versions }}")"

          git commit -m "$msg_title" -m "$msg_body"
          git push
